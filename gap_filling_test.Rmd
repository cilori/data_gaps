---
title: "Gap filling with metR::ImputeEOF"
date: "`r Sys.Date()`"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.width=16, fig.height=10)
library(dplyr)
library(fst)
library(data.table)
library(oceancolouR)
library(ggplot2)
library(raster)
library(gridExtra)
library(lubridate)
library(latticeExtra)
library(sp)
library(lmodel2)
library(broom)
library(gridExtra)
library(geodist)
data("wrld_simpl", package = "maptools")

data("nwa_bins_4km")
data("nwa_lats_4km")
data("nwa_lons_4km")

lats <- range(nwa_lats_4km)
lons <- range(nwa_lons_4km)

sensor <- "MODIS"
year <- 2015
days <- c(53, 172)
weeks <- c(7, 22)
low_percov <- 5
num_years <- 0
low_chla <- 0
high_chla <- 64


#*******************************************************************************
# custom functions

make_map <- function(df,title,log_raster=FALSE) {
    r1 <- var_to_rast(df %>% dplyr::select(bin, var))
    r2 <- var_to_rast(df %>% dplyr::select(bin, var_imputed))
    rextent <- raster::extent(c(xmn=lons[1], xmx=lons[2], ymn=lats[1], ymx=lats[2]))
    r1 <- crop(r1, rextent)
    r2 <- crop(r2, rextent)
    if (log_raster) {
      r1 <- log10(r1)
      r2 <- log10(r2)
    }
    r <- raster::stack(r1,r2)
    names(r) <- c("Original", "Filled")
    return(spplot(r, main=title, zlim=c(-1.5,2)) + latticeExtra::layer(sp::sp.polygons(wrld_simpl)))
}

cv_plot <- function(cv_df,intercept,slope,tab,title) {
  breaks <- c(0.01,0.1,1,10,100)
  ggplot(cv_df, aes(x=var, y=validation_pixels)) +
        stat_binhex(bins=80) +
        scale_fill_gradientn(colours=c("#DDDDDD", "#00007F", "blue", "#007FFF", "cyan", "#7FFF7F", "yellow", "#FF7F00", "red", "#7F0000"), na.value="#000000FF") +
        scale_x_log10(limits=range(breaks),breaks=breaks,labels=breaks) +
        scale_y_log10(limits=range(breaks),breaks=breaks,labels=breaks) +
        geom_abline(intercept=0, slope=1) +
        geom_abline(intercept=intercept, slope=slope, colour="red", alpha=0.6, linetype="dashed") +
        labs(x="Real value", y="Filled value") +
        ggtitle(title) +
        theme_bw() +
        theme(legend.position="none") +
        annotation_custom(tab, xmin=-Inf, xmax=0.1, ymin=0.8, ymax=Inf)
}

cv_tab <- function(cv_df) {
  lm_cv <- lmodel2(log10(validation_pixels) ~ log10(var), data=cv_df)
  stats_df <- data.frame(matrix(c(as.numeric(broom::glance(lm_cv)[,c("r.squared", "p.value", "nobs")]),
                                  as.numeric(unlist(broom::tidy(lm_cv)[5:6,"estimate"]))), ncol=1),
                         row.names=c("R^2", "p-value", "nobs", "intercept", "slope"),
                         stringsAsFactors = FALSE)
  tab <- tableGrob(round(stats_df,3), cols=NULL)
  return(list(stats_df=stats_df,tab=tab))
}

is_tab <- function(is_df) {
  lm_is <- lmodel2(log10(sat_chla) ~ log10(HPLC_CHLA), data=is_df)
  stats_df <- data.frame(matrix(c(as.numeric(broom::glance(lm_is)[,c("r.squared", "p.value", "nobs")]),
                                  as.numeric(unlist(broom::tidy(lm_is)[5:6,"estimate"]))), ncol=1),
                         row.names=c("R^2", "p-value", "nobs", "intercept", "slope"),
                         stringsAsFactors = FALSE)
  tab <- tableGrob(round(stats_df,3), cols=NULL)
  return(list(stats_df=stats_df,tab=tab))
}

matchup_plot <- function(matchups) {
  lm_insitu <- is_tab(matchups)
  lm_real <- broom::tidy(lmodel2(log10(sat_chla) ~ log10(HPLC_CHLA), data=matchups %>% dplyr::filter(Satellite=="Real")))
  lm_filled <- broom::tidy(lmodel2(log10(sat_chla) ~ log10(HPLC_CHLA), data=matchups %>% dplyr::filter(Satellite=="Filled")))
  
  ggplot(matchups, aes(x=HPLC_CHLA, y=sat_chla, color=Satellite)) +
    geom_point() +
    theme_bw() +
    geom_abline(intercept=0, slope=1) +
    geom_abline(intercept=lm_insitu$stats_df[4,], slope=lm_insitu$stats_df[5,], linetype="dashed") +
    geom_abline(intercept=lm_filled$estimate[5], slope=lm_filled$estimate[6], color="#F8766D", linetype="dashed") +
    geom_abline(intercept=lm_real$estimate[5], slope=lm_real$estimate[6], color="#00B0F6", linetype="dashed") +
    scale_x_log10(limits=c(0.05,20)) +
    scale_y_log10(limits=c(0.05,20)) +
    labs(x="In situ chla", y="Satellite chla", color="") +
    annotation_custom(lm_insitu$tab, xmin=-Inf, xmax=0.06, ymin=0.5, ymax=Inf) +
    theme(legend.position=c(0.85,0.15))
}


#*******************************************************************************
# prepare in situ matchup data

in_situ_file <- "../satellite_validation/01_in_situ_data/HPLC_1997-2020_20201110.csv"
in_situ_df <- read.csv(in_situ_file, header=TRUE) %>%
  dplyr::filter(YEAR==year) %>%
  dplyr::mutate(cruise_id = as.character(cruise_id)) %>%
  dplyr::select(ID, DEPTH, LATDEC, LONGDEC, YEAR, DOY, HPLC_CHLA) %>%
  dplyr::group_by(YEAR,DOY,LATDEC,LONGDEC) %>%
  dplyr::summarize_all(.fun=dplyr::first) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(YEAR,DOY,DEPTH)
# add columns for satellite bin and distance to bin
sat_loc_df <- data.frame(bin=nwa_bins_4km, lon=nwa_lons_4km, lat=nwa_lats_4km, stringsAsFactors = FALSE)
is_loc_df <- in_situ_df %>% dplyr::distinct(LONGDEC, LATDEC)
is_loc_df <- dplyr::bind_cols(
  is_loc_df,
  lapply(1:nrow(is_loc_df),
    function(i) {
      is_lon <- is_loc_df$LONGDEC[i]
      is_lat <- is_loc_df$LATDEC[i]
      tmp_sat_df <- sat_loc_df %>% dplyr::filter(abs(lat - is_lat) < 1 & abs(lon - is_lon) < 1)
      tmp_sat_df$dist <- as.numeric(geodist(x=data.frame(lon=is_lon, lat=is_lat), y=tmp_sat_df %>% dplyr::select(lon, lat), measure="geodesic"))
      tmp_sat_df[which.min(tmp_sat_df$dist),c("dist","bin")]
    }) %>%
  do.call(rbind, .)
)
in_situ_df <- dplyr::left_join(in_situ_df, is_loc_df, by=c("LATDEC","LONGDEC")) %>%
  dplyr::mutate(week8 = week8(lubridate::as_date(paste(YEAR, DOY), format="%Y %j")),
                time_week = YEAR + (week8-1)/46,
                time_day = YEAR + (DOY-1)/ifelse(leap_year(YEAR),366,365)) %>%
  as.data.frame()

```

# Description

This displays the resulting filled images calculated using the `fill_gaps.R` script.  

Different parameters were tested on the following data (note there are 2 different weeks, one with good weekly coverage and one without):  

    Region: Northwest Atlantic (NWA, 39 to 82 N, 42 to 95 W)  
    Sensor: `r sensor`   
    Resolution: 4km   
    Processing level: Level 3, binned (L3b)  
    Year: `r year`  
    Weeks: `r paste0(weeks, collapse=", ")`  
    Pixels outside `r paste0(c(low_chla, high_chla), collapse="-")` mg m^-3 removed  
    Days with < `r low_percov`% coverage removed  

ImputeEOF removes randomly sampled valid pixels for cross-validation. The number of pixels used is the maximum of 30, or 10% of the pixels. The function continues adding EOFs and calculating the resulting RMSE between real and reconstructed cross-validation pixels until the difference between the current RMSE and RMSE of the previous iteration is below a certain threshold (i.e. adding the most recent EOF did not significantly improve the RMSE). The threshold, called the "tolerance", is different depending on whether you're filling data in linear space or in log space, since a log RMSE will be only a fraction of the size of a linear RMSE:  

Tolerance for filling logged data: 0.001  
Tolerance for filling linear data: 0.01  

We start by using a year of data to fill the gaps, and compare different methods below. Then, using the best options, we'll try using a longer time series.  

For each method of filling gaps, we'll examine the following:  

  - original image(s) vs filled image(s)  
  - 2 separate maps: one early in the year and one later, to check performance on days with low and medium/high spatial coverage  
  - linear regression of filled pixels vs original pixels (in log space) using randomly-spaced cross-validation pixels  
  - various metrics:  
      - RMSE and number of EOFs used  
      - R^2, p-value, number of observations (nobs), intercept, and slope of the cross-validation regression  
  - linear regression of in situ samples VS filled satellite data  

The linear regression uses the standard major axis method (SMA) from `lmodel2::lmodel2()`, since it minimizes the area of the triangle instead of the distance in the x or y direction alone (i.e. it assumes there is error in both the independent and dependent variables, the "real" and filled/reconstructed data).  

Also note that for the tests that involve filling an 8day composite, in situ matchups should be interpreted with caution because of the long temporal bin and the changes that could occur in concentrations and patterns within that time span.  


An analysis of DINEOF on the Canadian Pacific coast:  
[Hilborn A, Costa M. Applications of DINEOF to Satellite-Derived Chlorophyll-a from a Productive Coastal Region. Remote Sensing. 2018; 10(9):1449. https://doi.org/10.3390/rs10091449](https://www.mdpi.com/2072-4292/10/9/1449)  



# 8day vs daily

Chla algorithm: OCx  
Logged/linear data: Logged  

Which is better - filling the gaps in 8day data, or filling gaps in daily data and then averaging it into an 8day image?  

Although some R^2 metrics appear better for the daily filled version, overall the 8day cross-validation data has a better fit and less bias (e.g. it identifies some patterns of higher concentration better than the daily fill).  



#### <b>8day</b>

```{r}

variable <- "CHL_OCX"
region <- "PANCAN"
input_years <- ifelse(num_years==0, year, paste0(range(plus_minus(year,num_years)), collapse="-"))
input_name <- paste0("output/filled_", region, "_", sensor, "_", variable, "_", input_years, "_")

fill_log <- TRUE

# load data
composite <- "8day"
file <- paste0(input_name, composite, ifelse(fill_log, "_logged", ""), "_randomCVpts")
df <- as.data.table(read_fst(paste0(file, ".fst")))
load(paste0(file, "_attr.rda"))

# format
num_weeks <- dim(df)[1]/num_pix$NWA$`4km`
available_weeks <- as.integer(round(sort(unique((df$time-year)*46 + 1))))
mat_var <- matrix(df$var, ncol=num_weeks, byrow=TRUE)
mat_var_imputed <- matrix(df$var_imputed, ncol=num_weeks, byrow=TRUE)

# make maps for each week
map1 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[1]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[1]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[1]),
                log_raster=TRUE)
map2 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[2]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[2]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[2]),
                log_raster=TRUE)

# perform linear regression on all cross-validation pixels, and extract stats
cv_df <- df %>% dplyr::filter(is.finite(validation_pixels))
tab <- cv_tab(cv_df)
p <- cv_plot(cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,"CV regression - all pixels")

# do the same with individual selected weeks to test
week1_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[1]-1)/46))
week2_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[2]-1)/46))
if (fill_log) {
  week_rmses <- c(rmse(log10(week1_cv_df$var), log10(week1_cv_df$validation_pixels)),
                  rmse(log10(week2_cv_df$var), log10(week2_cv_df$validation_pixels)))
} else {
  week_rmses <- c(rmse(week1_cv_df$var, week1_cv_df$validation_pixels),
                  rmse(week2_cv_df$var, week2_cv_df$validation_pixels))
}
tab <- cv_tab(week1_cv_df)
p1 <- cv_plot(week1_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[1]))
tab <- cv_tab(week2_cv_df)
p2 <- cv_plot(week2_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[2]))

# remove repetitive axis titles/scales
p2 <- p2 + theme(axis.title.y=element_blank(), axis.text.y=element_blank())
p <- p + theme(axis.title.y=element_blank(), axis.text.y=element_blank())

matchups <- dplyr::left_join(df, in_situ_df %>% dplyr::rename(time=time_week), by=c("bin", "time")) %>%
  dplyr::filter(is.finite(ID)) %>%
  dplyr::rename(Real=var, Filled=validation_pixels) %>%
  tidyr::pivot_longer(cols=c(Real, Filled), names_to="Satellite", values_to="sat_chla", values_drop_na=TRUE) %>%
  dplyr::arrange(Satellite, time)

isp <- matchup_plot(matchups)

cat("Number of EOF:", attr_df$eof, "\n",
    "Total RMSE:", attr_df$rmse, "\n",
    "Week", weeks[1], "RMSE:", week_rmses[1], "\n",
    "Week", weeks[2], "RMSE:", week_rmses[2])
grid.arrange(grobs=list(map1,map2,isp,p1,p2,p), nrow=2)

```

#### <b>Daily</b>

```{r}

composite <- "daily"
file <- paste0(input_name, composite, ifelse(fill_log, "_logged", ""), "_randomCVpts")
df <- as.data.table(read_fst(paste0(file, ".fst")))
load(paste0(file, "_attr.rda"))

days_in_the_week <- list(yday(week8_date(year,weeks[1])):(yday(week8_date(year,weeks[1]))+7),
                         yday(week8_date(year,weeks[2])):(yday(week8_date(year,weeks[2]))+7))
num_days <- dim(df)[1]/num_pix$NWA$`4km`
available_days <- as.integer(round(sort(unique((df$time-year)*ifelse(leap_year(year),366,365) + 1))))
mat_var <- matrix(df$var, ncol=num_days, byrow=TRUE)
mat_var_imputed <- matrix(df$var_imputed, ncol=num_days, byrow=TRUE)
map1 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=rowMeans(mat_var[,available_days %in% days_in_the_week[[1]]], na.rm=TRUE),
                            var_imputed=rowMeans(mat_var_imputed[,available_days %in% days_in_the_week[[1]]], na.rm=TRUE),
                            stringsAsFactors = FALSE),
                title=paste0("Daily filled, then 8day avg - week ",weeks[1]),
                log_raster=TRUE)
map2 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=rowMeans(mat_var[,available_days %in% days_in_the_week[[2]]], na.rm=TRUE),
                            var_imputed=rowMeans(mat_var_imputed[,available_days %in% days_in_the_week[[2]]], na.rm=TRUE),
                            stringsAsFactors = FALSE),
                title=paste0("Daily filled, then 8day avg - week ",weeks[2]),
                log_raster=TRUE)
# perform linear regression on cross-validation pixels, and extract stats
cv_df <- df %>% dplyr::filter(is.finite(validation_pixels))
lm_cv <- lmodel2(log10(validation_pixels) ~ log10(var), data=cv_df)
stats_df <- data.frame(matrix(c(as.numeric(broom::glance(lm_cv)[,c("r.squared", "p.value", "nobs")]),
                                as.numeric(unlist(broom::tidy(lm_cv)[5:6,"estimate"]))), ncol=1),
                       row.names=c("R^2", "p-value", "nobs", "intercept", "slope"),
                       stringsAsFactors = FALSE)
tab <- tableGrob(round(stats_df,3), cols=NULL)
p <- cv_plot(cv_df,stats_df[4,],stats_df[5,],tab,"Cross-validation pixel regression")

# do the same with individual selected weeks to test
week1_cv_df <- cv_df %>% dplyr::filter(time %in% (year + (days_in_the_week[[1]]-1)/ifelse(leap_year(year),366,365)))
week2_cv_df <- cv_df %>% dplyr::filter(time %in% (year + (days_in_the_week[[2]]-1)/ifelse(leap_year(year),366,365)))
if (fill_log) {
  week_rmses <- c(rmse(log10(week1_cv_df$var), log10(week1_cv_df$validation_pixels)),
                  rmse(log10(week2_cv_df$var), log10(week2_cv_df$validation_pixels)))
} else {
  week_rmses <- c(rmse(week1_cv_df$var, week1_cv_df$validation_pixels),
                  rmse(week2_cv_df$var, week2_cv_df$validation_pixels))
}
tab <- cv_tab(week1_cv_df)
p1 <- cv_plot(week1_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[1]))
tab <- cv_tab(week2_cv_df)
p2 <- cv_plot(week2_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[2]))

# remove repetitive axis titles/scales
p2 <- p2 + theme(axis.title.y=element_blank(), axis.text.y=element_blank())
p <- p + theme(axis.title.y=element_blank(), axis.text.y=element_blank())

matchups <- dplyr::left_join(df, in_situ_df %>% dplyr::rename(time=time_day), by=c("bin", "time")) %>%
  dplyr::filter(is.finite(ID)) %>%
  dplyr::rename(Real=var, Filled=validation_pixels) %>%
  tidyr::pivot_longer(cols=c(Real, Filled), names_to="Satellite", values_to="sat_chla", values_drop_na=TRUE) %>%
  dplyr::arrange(Satellite, time)

isp <- matchup_plot(matchups)

cat("Number of EOF:", attr_df$eof, "\n",
    "Total RMSE:", attr_df$rmse, "\n",
    "Week", weeks[1], "RMSE:", week_rmses[1], "\n",
    "Week", weeks[2], "RMSE:", week_rmses[2])
grid.arrange(grobs=list(map1,map2,isp,p1,p2,p), nrow=2)

```




# OCx vs POLY4

Temporal binning: 8day  
Logged/linear data: Logged  

Should the OCx or POLY4 algorithm be used? Note that POLY4 has shown to remove some of the bias in the NWA.  
OCx = global band-ratio  
POLY4 = regional band-ratio, tuned to NWA  

The POLY4 algorithm does appear to remove some of the bias and improve the validity of the reconstructed values.  



#### <b>OCx</b>

```{r}

variable <- "CHL_OCX"
region <- "PANCAN"
input_years <- ifelse(num_years==0, year, paste0(range(plus_minus(year,num_years)), collapse="-"))
input_name <- paste0("output/filled_", region, "_", sensor, "_", variable, "_", input_years, "_")

fill_log <- TRUE

# load data
composite <- "8day"
file <- paste0(input_name, composite, ifelse(fill_log, "_logged", ""), "_randomCVpts")
df <- as.data.table(read_fst(paste0(file, ".fst")))
load(paste0(file, "_attr.rda"))

# format
num_weeks <- dim(df)[1]/num_pix$NWA$`4km`
available_weeks <- as.integer(round(sort(unique((df$time-year)*46 + 1))))
mat_var <- matrix(df$var, ncol=num_weeks, byrow=TRUE)
mat_var_imputed <- matrix(df$var_imputed, ncol=num_weeks, byrow=TRUE)

# make maps for each week
map1 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[1]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[1]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[1]),
                log_raster=TRUE)
map2 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[2]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[2]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[2]),
                log_raster=TRUE)

# perform linear regression on all cross-validation pixels, and extract stats
cv_df <- df %>% dplyr::filter(is.finite(validation_pixels))
tab <- cv_tab(cv_df)
p <- cv_plot(cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,"CV regression - all pixels")

# do the same with individual selected weeks to test
week1_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[1]-1)/46))
week2_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[2]-1)/46))
if (fill_log) {
  week_rmses <- c(rmse(log10(week1_cv_df$var), log10(week1_cv_df$validation_pixels)),
                  rmse(log10(week2_cv_df$var), log10(week2_cv_df$validation_pixels)))
} else {
  week_rmses <- c(rmse(week1_cv_df$var, week1_cv_df$validation_pixels),
                  rmse(week2_cv_df$var, week2_cv_df$validation_pixels))
}
tab <- cv_tab(week1_cv_df)
p1 <- cv_plot(week1_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[1]))
tab <- cv_tab(week2_cv_df)
p2 <- cv_plot(week2_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[2]))

# remove repetitive axis titles/scales
p2 <- p2 + theme(axis.title.y=element_blank(), axis.text.y=element_blank())
p <- p + theme(axis.title.y=element_blank(), axis.text.y=element_blank())

matchups <- dplyr::left_join(df, in_situ_df %>% dplyr::rename(time=time_week), by=c("bin", "time")) %>%
  dplyr::filter(is.finite(ID)) %>%
  dplyr::rename(Real=var, Filled=validation_pixels) %>%
  tidyr::pivot_longer(cols=c(Real, Filled), names_to="Satellite", values_to="sat_chla", values_drop_na=TRUE) %>%
  dplyr::arrange(Satellite, time)

isp <- matchup_plot(matchups)

cat("Number of EOF:", attr_df$eof, "\n",
    "Total RMSE:", attr_df$rmse, "\n",
    "Week", weeks[1], "RMSE:", week_rmses[1], "\n",
    "Week", weeks[2], "RMSE:", week_rmses[2])
grid.arrange(grobs=list(map1,map2,isp,p1,p2,p), nrow=2)

```


#### <b>POLY4</b>

```{r}

variable <- "CHL_POLY4"
region <- "NWA"
input_years <- ifelse(num_years==0, year, paste0(range(plus_minus(year,num_years)), collapse="-"))
input_name <- paste0("output/filled_", region, "_", sensor, "_", variable, "_", input_years, "_")

fill_log <- TRUE

# load data
composite <- "8day"
file <- paste0(input_name, composite, ifelse(fill_log, "_logged", ""), "_randomCVpts")
df <- as.data.table(read_fst(paste0(file, ".fst")))
load(paste0(file, "_attr.rda"))

# format
num_weeks <- dim(df)[1]/num_pix$NWA$`4km`
available_weeks <- as.integer(round(sort(unique((df$time-year)*46 + 1))))
mat_var <- matrix(df$var, ncol=num_weeks, byrow=TRUE)
mat_var_imputed <- matrix(df$var_imputed, ncol=num_weeks, byrow=TRUE)

# make maps for each week
map1 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[1]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[1]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[1]),
                log_raster=TRUE)
map2 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[2]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[2]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[2]),
                log_raster=TRUE)

# perform linear regression on all cross-validation pixels, and extract stats
cv_df <- df %>% dplyr::filter(is.finite(validation_pixels))
tab <- cv_tab(cv_df)
p <- cv_plot(cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,"CV regression - all pixels")

# do the same with individual selected weeks to test
week1_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[1]-1)/46))
week2_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[2]-1)/46))
if (fill_log) {
  week_rmses <- c(rmse(log10(week1_cv_df$var), log10(week1_cv_df$validation_pixels)),
                  rmse(log10(week2_cv_df$var), log10(week2_cv_df$validation_pixels)))
} else {
  week_rmses <- c(rmse(week1_cv_df$var, week1_cv_df$validation_pixels),
                  rmse(week2_cv_df$var, week2_cv_df$validation_pixels))
}
tab <- cv_tab(week1_cv_df)
p1 <- cv_plot(week1_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[1]))
tab <- cv_tab(week2_cv_df)
p2 <- cv_plot(week2_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[2]))

# remove repetitive axis titles/scales
p2 <- p2 + theme(axis.title.y=element_blank(), axis.text.y=element_blank())
p <- p + theme(axis.title.y=element_blank(), axis.text.y=element_blank())

matchups <- dplyr::left_join(df, in_situ_df %>% dplyr::rename(time=time_week), by=c("bin", "time")) %>%
  dplyr::filter(is.finite(ID)) %>%
  dplyr::rename(Real=var, Filled=validation_pixels) %>%
  tidyr::pivot_longer(cols=c(Real, Filled), names_to="Satellite", values_to="sat_chla", values_drop_na=TRUE) %>%
  dplyr::arrange(Satellite, time)

isp <- matchup_plot(matchups)

cat("Number of EOF:", attr_df$eof, "\n",
    "Total RMSE:", attr_df$rmse, "\n",
    "Week", weeks[1], "RMSE:", week_rmses[1], "\n",
    "Week", weeks[2], "RMSE:", week_rmses[2])
grid.arrange(grobs=list(map1,map2,isp,p1,p2,p), nrow=2)

```


# Log vs linear

Temporal binning: 8day  
Chla algorithm: POLY4  

Should we use logged data or linear data to fill the gaps?  
Note the process for the log option:  

  - log the data
  - set values <= 0 to NA  
  - fill gaps using ImputeEOF()  
  - transform filled image back to linear space  

Logged data gives a smoother fill as it is not negatively impacted by isolated spikes over relatively low and consistent concentrations.  



#### <b>Log</b>

```{r}

variable <- "CHL_POLY4"
region <- "NWA"
input_years <- ifelse(num_years==0, year, paste0(range(plus_minus(year,num_years)), collapse="-"))
input_name <- paste0("output/filled_", region, "_", sensor, "_", variable, "_", input_years, "_")

fill_log <- TRUE

# load data
composite <- "8day"
file <- paste0(input_name, composite, ifelse(fill_log, "_logged", ""), "_randomCVpts")
df <- as.data.table(read_fst(paste0(file, ".fst")))
load(paste0(file, "_attr.rda"))

# format
num_weeks <- dim(df)[1]/num_pix$NWA$`4km`
available_weeks <- as.integer(round(sort(unique((df$time-year)*46 + 1))))
mat_var <- matrix(df$var, ncol=num_weeks, byrow=TRUE)
mat_var_imputed <- matrix(df$var_imputed, ncol=num_weeks, byrow=TRUE)

# make maps for each week
map1 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[1]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[1]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[1]),
                log_raster=TRUE)
map2 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[2]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[2]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[2]),
                log_raster=TRUE)

# perform linear regression on all cross-validation pixels, and extract stats
cv_df <- df %>% dplyr::filter(is.finite(validation_pixels))
tab <- cv_tab(cv_df)
p <- cv_plot(cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,"CV regression - all pixels")

# do the same with individual selected weeks to test
week1_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[1]-1)/46))
week2_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[2]-1)/46))
if (fill_log) {
  week_rmses <- c(rmse(log10(week1_cv_df$var), log10(week1_cv_df$validation_pixels)),
                  rmse(log10(week2_cv_df$var), log10(week2_cv_df$validation_pixels)))
} else {
  week_rmses <- c(rmse(week1_cv_df$var, week1_cv_df$validation_pixels),
                  rmse(week2_cv_df$var, week2_cv_df$validation_pixels))
}
tab <- cv_tab(week1_cv_df)
p1 <- cv_plot(week1_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[1]))
tab <- cv_tab(week2_cv_df)
p2 <- cv_plot(week2_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[2]))

# remove repetitive axis titles/scales
p2 <- p2 + theme(axis.title.y=element_blank(), axis.text.y=element_blank())
p <- p + theme(axis.title.y=element_blank(), axis.text.y=element_blank())

matchups <- dplyr::left_join(df, in_situ_df %>% dplyr::rename(time=time_week), by=c("bin", "time")) %>%
  dplyr::filter(is.finite(ID)) %>%
  dplyr::rename(Real=var, Filled=validation_pixels) %>%
  tidyr::pivot_longer(cols=c(Real, Filled), names_to="Satellite", values_to="sat_chla", values_drop_na=TRUE) %>%
  dplyr::arrange(Satellite, time)

isp <- matchup_plot(matchups)

cat("Number of EOF:", attr_df$eof, "\n",
    "Total RMSE:", attr_df$rmse, "\n",
    "Week", weeks[1], "RMSE:", week_rmses[1], "\n",
    "Week", weeks[2], "RMSE:", week_rmses[2])
grid.arrange(grobs=list(map1,map2,isp,p1,p2,p), nrow=2)

```

#### <b>Linear</b>

```{r}

variable <- "CHL_POLY4"
region <- "NWA"
input_years <- ifelse(num_years==0, year, paste0(range(plus_minus(year,num_years)), collapse="-"))
input_name <- paste0("output/filled_", region, "_", sensor, "_", variable, "_", input_years, "_")

fill_log <- FALSE

# load data
composite <- "8day"
file <- paste0(input_name, composite, ifelse(fill_log, "_logged", ""), "_randomCVpts")
df <- as.data.table(read_fst(paste0(file, ".fst")))
load(paste0(file, "_attr.rda"))

# format
num_weeks <- dim(df)[1]/num_pix$NWA$`4km`
available_weeks <- as.integer(round(sort(unique((df$time-year)*46 + 1))))
mat_var <- matrix(df$var, ncol=num_weeks, byrow=TRUE)
mat_var_imputed <- matrix(df$var_imputed, ncol=num_weeks, byrow=TRUE)

# make maps for each week
map1 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[1]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[1]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[1]),
                log_raster=TRUE)
map2 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[2]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[2]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[2]),
                log_raster=TRUE)

# perform linear regression on all cross-validation pixels, and extract stats
cv_df <- df %>% dplyr::filter(is.finite(validation_pixels))
tab <- cv_tab(cv_df)
p <- cv_plot(cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,"CV regression - all pixels")

# do the same with individual selected weeks to test
week1_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[1]-1)/46))
week2_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[2]-1)/46))
if (fill_log) {
  week_rmses <- c(rmse(log10(week1_cv_df$var), log10(week1_cv_df$validation_pixels)),
                  rmse(log10(week2_cv_df$var), log10(week2_cv_df$validation_pixels)))
} else {
  week_rmses <- c(rmse(week1_cv_df$var, week1_cv_df$validation_pixels),
                  rmse(week2_cv_df$var, week2_cv_df$validation_pixels))
}
tab <- cv_tab(week1_cv_df)
p1 <- cv_plot(week1_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[1]))
tab <- cv_tab(week2_cv_df)
p2 <- cv_plot(week2_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[2]))

# remove repetitive axis titles/scales
p2 <- p2 + theme(axis.title.y=element_blank(), axis.text.y=element_blank())
p <- p + theme(axis.title.y=element_blank(), axis.text.y=element_blank())

matchups <- dplyr::left_join(df, in_situ_df %>% dplyr::rename(time=time_week), by=c("bin", "time")) %>%
  dplyr::filter(is.finite(ID)) %>%
  dplyr::rename(Real=var, Filled=validation_pixels) %>%
  tidyr::pivot_longer(cols=c(Real, Filled), names_to="Satellite", values_to="sat_chla", values_drop_na=TRUE) %>%
  dplyr::arrange(Satellite, time)

isp <- matchup_plot(matchups)

cat("Number of EOF:", attr_df$eof, "\n",
    "Total RMSE:", attr_df$rmse, "\n",
    "Week", weeks[1], "RMSE:", week_rmses[1], "\n",
    "Week", weeks[2], "RMSE:", week_rmses[2])
grid.arrange(grobs=list(map1,map2,isp,p1,p2,p), nrow=2)

```




# Longer time series

If more satellite images are used in the algorithm, will it improve the results?  

Hilborn and Costa (2018) found that pixel reconstruction improved with more data in a smaller region on the Canadian Pacific coast. Up until this point we have only used one year of data to fill the gaps, but here we'll try adding more (an equal number of years on either side of the target year, `r year`).  

WARNING! Currently the 1year/3year/5year comparisons do not use the same CV pixels for 2015 (this will be updated soon for a more accurate comparison).  


#### <b>1 year</b>

```{r}

variable <- "CHL_POLY4"
region <- "NWA"
input_years <- ifelse(num_years==0, year, paste0(range(plus_minus(year,num_years)), collapse="-"))
input_name <- paste0("output/filled_", region, "_", sensor, "_", variable, "_", input_years, "_")

fill_log <- TRUE

# load data
composite <- "8day"
file <- paste0(input_name, composite, ifelse(fill_log, "_logged", ""), "_randomCVpts")
df <- as.data.table(read_fst(paste0(file, ".fst")))
load(paste0(file, "_attr.rda"))

# format
num_weeks <- dim(df)[1]/num_pix$NWA$`4km`
available_weeks <- as.integer(round(sort(unique((df$time-year)*46 + 1))))
mat_var <- matrix(df$var, ncol=num_weeks, byrow=TRUE)
mat_var_imputed <- matrix(df$var_imputed, ncol=num_weeks, byrow=TRUE)

# make maps for each week
map1 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[1]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[1]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[1]),
                log_raster=TRUE)
map2 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[2]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[2]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[2]),
                log_raster=TRUE)

# perform linear regression on all cross-validation pixels, and extract stats
cv_df <- df %>% dplyr::filter(is.finite(validation_pixels))
tab <- cv_tab(cv_df)
p <- cv_plot(cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,"CV regression - all pixels")

# do the same with individual selected weeks to test
week1_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[1]-1)/46))
week2_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[2]-1)/46))
if (fill_log) {
  week_rmses <- c(rmse(log10(week1_cv_df$var), log10(week1_cv_df$validation_pixels)),
                  rmse(log10(week2_cv_df$var), log10(week2_cv_df$validation_pixels)))
} else {
  week_rmses <- c(rmse(week1_cv_df$var, week1_cv_df$validation_pixels),
                  rmse(week2_cv_df$var, week2_cv_df$validation_pixels))
}
tab <- cv_tab(week1_cv_df)
p1 <- cv_plot(week1_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[1]))
tab <- cv_tab(week2_cv_df)
p2 <- cv_plot(week2_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[2]))

# remove repetitive axis titles/scales
p2 <- p2 + theme(axis.title.y=element_blank(), axis.text.y=element_blank())
p <- p + theme(axis.title.y=element_blank(), axis.text.y=element_blank())

matchups <- dplyr::left_join(df, in_situ_df %>% dplyr::rename(time=time_week), by=c("bin", "time")) %>%
  dplyr::filter(is.finite(ID)) %>%
  dplyr::rename(Real=var, Filled=validation_pixels) %>%
  tidyr::pivot_longer(cols=c(Real, Filled), names_to="Satellite", values_to="sat_chla", values_drop_na=TRUE) %>%
  dplyr::arrange(Satellite, time)

isp <- matchup_plot(matchups)

cat("Number of EOF:", attr_df$eof, "\n",
    "Total RMSE:", attr_df$rmse, "\n",
    "Week", weeks[1], "RMSE:", week_rmses[1], "\n",
    "Week", weeks[2], "RMSE:", week_rmses[2])
grid.arrange(grobs=list(map1,map2,isp,p1,p2,p), nrow=2)

```


#### <b>3 years</b>

```{r}

num_years <- 1

variable <- "CHL_POLY4"
region <- "NWA"
input_years <- ifelse(num_years==0, year, paste0(range(plus_minus(year,num_years)), collapse="-"))
input_name <- paste0("output/filled_", region, "_", sensor, "_", variable, "_", input_years, "_")

fill_log <- TRUE

# load data
composite <- "8day"
file <- paste0(input_name, composite, ifelse(fill_log, "_logged", ""), "_randomCVpts")
df <- as.data.table(read_fst(paste0(file, ".fst")))
load(paste0(file, "_attr.rda"))

# format
df_2015 <- df %>% dplyr::filter(floor(time)==year)
num_weeks <- dim(df_2015)[1]/num_pix$NWA$`4km`
available_weeks <- as.integer(round(sort(unique((df_2015$time-year)*46 + 1))))
mat_var <- matrix(df_2015$var, ncol=num_weeks, byrow=TRUE)
mat_var_imputed <- matrix(df_2015$var_imputed, ncol=num_weeks, byrow=TRUE)

# make maps for each week
map1 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[1]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[1]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[1]),
                log_raster=TRUE)
map2 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[2]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[2]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[2]),
                log_raster=TRUE)

# perform linear regression on all cross-validation pixels, and extract stats
cv_df <- df %>% dplyr::filter(is.finite(validation_pixels))
tab <- cv_tab(cv_df)
p <- cv_plot(cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,"CV regression - all pixels")

# do the same with individual selected weeks to test
week1_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[1]-1)/46))
week2_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[2]-1)/46))
if (fill_log) {
  week_rmses <- c(rmse(log10(week1_cv_df$var), log10(week1_cv_df$validation_pixels)),
                  rmse(log10(week2_cv_df$var), log10(week2_cv_df$validation_pixels)))
} else {
  week_rmses <- c(rmse(week1_cv_df$var, week1_cv_df$validation_pixels),
                  rmse(week2_cv_df$var, week2_cv_df$validation_pixels))
}
tab <- cv_tab(week1_cv_df)
p1 <- cv_plot(week1_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[1]))
tab <- cv_tab(week2_cv_df)
p2 <- cv_plot(week2_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[2]))

# remove repetitive axis titles/scales
p2 <- p2 + theme(axis.title.y=element_blank(), axis.text.y=element_blank())
p <- p + theme(axis.title.y=element_blank(), axis.text.y=element_blank())

matchups <- dplyr::left_join(df, in_situ_df %>% dplyr::rename(time=time_week), by=c("bin", "time")) %>%
  dplyr::filter(is.finite(ID)) %>%
  dplyr::rename(Real=var, Filled=validation_pixels) %>%
  tidyr::pivot_longer(cols=c(Real, Filled), names_to="Satellite", values_to="sat_chla", values_drop_na=TRUE) %>%
  dplyr::arrange(Satellite, time)

isp <- matchup_plot(matchups)

cat("Number of EOF:", attr_df$eof, "\n",
    "Total RMSE:", attr_df$rmse, "\n",
    "Week", weeks[1], "RMSE:", week_rmses[1], "\n",
    "Week", weeks[2], "RMSE:", week_rmses[2])
grid.arrange(grobs=list(map1,map2,isp,p1,p2,p), nrow=2)

```


#### <b>5 years</b>

```{r}

num_years <- 2

variable <- "CHL_POLY4"
region <- "NWA"
input_years <- ifelse(num_years==0, year, paste0(range(plus_minus(year,num_years)), collapse="-"))
input_name <- paste0("output/filled_", region, "_", sensor, "_", variable, "_", input_years, "_")

fill_log <- TRUE

# load data
composite <- "8day"
file <- paste0(input_name, composite, ifelse(fill_log, "_logged", ""), "_randomCVpts")
df <- as.data.table(read_fst(paste0(file, ".fst")))
load(paste0(file, "_attr.rda"))

# format
df_2015 <- df %>% dplyr::filter(floor(time)==year)
num_weeks <- dim(df_2015)[1]/num_pix$NWA$`4km`
available_weeks <- as.integer(round(sort(unique((df_2015$time-year)*46 + 1))))
mat_var <- matrix(df_2015$var, ncol=num_weeks, byrow=TRUE)
mat_var_imputed <- matrix(df_2015$var_imputed, ncol=num_weeks, byrow=TRUE)

# make maps for each week
map1 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[1]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[1]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[1]),
                log_raster=TRUE)
map2 <- make_map(data.frame(bin=nwa_bins_4km,
                            var=mat_var[,available_weeks==weeks[2]],
                            var_imputed=mat_var_imputed[,available_weeks==weeks[2]],
                            stringsAsFactors = FALSE),
                title=paste0("8day filled - week ",weeks[2]),
                log_raster=TRUE)

# perform linear regression on all cross-validation pixels, and extract stats
cv_df <- df %>% dplyr::filter(is.finite(validation_pixels))
tab <- cv_tab(cv_df)
p <- cv_plot(cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,"CV regression - all pixels")

# do the same with individual selected weeks to test
week1_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[1]-1)/46))
week2_cv_df <- cv_df %>% dplyr::filter(time==(year + (weeks[2]-1)/46))
if (fill_log) {
  week_rmses <- c(rmse(log10(week1_cv_df$var), log10(week1_cv_df$validation_pixels)),
                  rmse(log10(week2_cv_df$var), log10(week2_cv_df$validation_pixels)))
} else {
  week_rmses <- c(rmse(week1_cv_df$var, week1_cv_df$validation_pixels),
                  rmse(week2_cv_df$var, week2_cv_df$validation_pixels))
}
tab <- cv_tab(week1_cv_df)
p1 <- cv_plot(week1_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[1]))
tab <- cv_tab(week2_cv_df)
p2 <- cv_plot(week2_cv_df,tab$stats_df[4,],tab$stats_df[5,],tab$tab,paste0("CV regression - week ", weeks[2]))

# remove repetitive axis titles/scales
p2 <- p2 + theme(axis.title.y=element_blank(), axis.text.y=element_blank())
p <- p + theme(axis.title.y=element_blank(), axis.text.y=element_blank())

matchups <- dplyr::left_join(df, in_situ_df %>% dplyr::rename(time=time_week), by=c("bin", "time")) %>%
  dplyr::filter(is.finite(ID)) %>%
  dplyr::rename(Real=var, Filled=validation_pixels) %>%
  tidyr::pivot_longer(cols=c(Real, Filled), names_to="Satellite", values_to="sat_chla", values_drop_na=TRUE) %>%
  dplyr::arrange(Satellite, time)

isp <- matchup_plot(matchups)

cat("Number of EOF:", attr_df$eof, "\n",
    "Total RMSE:", attr_df$rmse, "\n",
    "Week", weeks[1], "RMSE:", week_rmses[1], "\n",
    "Week", weeks[2], "RMSE:", week_rmses[2])
grid.arrange(grobs=list(map1,map2,isp,p1,p2,p), nrow=2)

```




# Larger area

Here we'll try adjusting the region used to fill the data.  


```{r}

```


